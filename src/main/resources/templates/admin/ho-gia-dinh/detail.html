<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi ti·∫øt h·ªô gia ƒë√¨nh - Qu·∫£n l√Ω chung c∆∞</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <style>
        .detail-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .info-label {
            font-weight: 600;
            color: #64748b;
            font-size: 14px;
        }
        
        .info-value {
            color: #1e293b;
            font-size: 16px;
        }
        
        .member-search-section {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .text-muted {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            display: block;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>BLUE MOON</h3>
            </div>
            
            <nav class="sidebar-menu">
                <ul>
                    <li>
                        <a th:href="@{/admin/dashboard}">
                            <img src="/images/img4.png" alt="Dashboard" style="width: 18px; height: 18px; margin-right: 12px;"> Dashboard
                        </a>
                    </li>
                    
                    <li>
                        <a th:href="@{/admin/doi-tuong}">
                            <img src="/images/quan-ly-cu-dan.png" alt="Qu·∫£n l√Ω c∆∞ d√¢n" style="width: 18px; height: 18px; margin-right: 12px;"> Qu·∫£n l√Ω c∆∞ d√¢n
                        </a>
                    </li>
                    
                    <li>
                        <a th:href="@{/admin/ho-gia-dinh}" class="active">
                            <img src="/images/ho-gia-dinh.png" alt="H·ªô gia ƒë√¨nh" style="width: 18px; height: 18px; margin-right: 12px;"> H·ªô gia ƒë√¨nh
                        </a>
                    </li>
                    
                    <li>
                        <a th:href="@{/admin/tai-san}">
                            <img src="/images/tai-san-chung-cu.png" alt="T√†i s·∫£n chung c∆∞" style="width: 18px; height: 18px; margin-right: 12px;"> T√†i s·∫£n chung c∆∞
                        </a>
                    </li>
                    
                    <li>
                        <a th:href="@{/admin/hoa-don}">
                            <img src="/images/hoa-don.png" alt="H√≥a ƒë∆°n" style="width: 18px; height: 18px; margin-right: 12px;"> H√≥a ƒë∆°n
                        </a>
                    </li>
                    
                    <li>
                        <a th:href="@{/admin/bao-cao-su-co}">
                            <img src="/images/bao-cao-su-co.png" alt="B√°o c√°o s·ª± c·ªë" style="width: 18px; height: 18px; margin-right: 12px;"> B√°o c√°o s·ª± c·ªë
                        </a>
                    </li>
                    
                    <li>
                        <a th:href="@{/admin/thong-bao}">
                            <img src="/images/thong-bao.png" alt="Th√¥ng b√°o" style="width: 18px; height: 18px; margin-right: 12px;"> Th√¥ng b√°o
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h2>Chi ti·∫øt h·ªô gia ƒë√¨nh</h2>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span>Xin ch√†o, <strong sec:authentication="name">Admin</strong></span>
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-sm btn-danger">ƒêƒÉng xu·∫•t</button>
                        </form>
                    </div>
                </div>
            </header>
            
            <main class="page-content">
                <div style="margin-bottom: 20px;">
                    <a th:href="@{/admin/ho-gia-dinh}" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
                </div>
                
                <!-- Th√¥ng tin h·ªô gia ƒë√¨nh -->
                <div class="detail-card">
                    <h3 style="margin-bottom: 20px; color: #1e293b; font-size: 20px;">üìã Th√¥ng tin h·ªô gia ƒë√¨nh</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">M√£ h·ªô:</span>
                            <span class="info-value" th:text="${hoGiaDinh.maHo}">H001</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">T√™n ch·ªß h·ªô:</span>
                            <span class="info-value" th:text="${hoGiaDinh.tenHo}">Nguy·ªÖn VƒÉn A</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">CƒÉn h·ªô:</span>
                            <span class="info-value" th:text="${canHo != null ? canHo.tenTaiSan + (canHo.viTri != null ? ' - ' + canHo.viTri : '') : 'Ch∆∞a c√≥'}">CƒÉn h·ªô 101</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ng√†y th√†nh l·∫≠p:</span>
                            <span class="info-value" th:text="${#temporals.format(hoGiaDinh.ngayThanhLap, 'dd/MM/yyyy')}">01/01/2020</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tr·∫°ng th√°i:</span>
                            <span class="badge" 
                                  th:classappend="${hoGiaDinh.trangThai == 'hoat_dong'} ? 'badge-success' : 'badge-secondary'"
                                  th:text="${hoGiaDinh.trangThai}">Ho·∫°t ƒë·ªông</span>
                        </div>
                        <div class="info-item" th:if="${hoGiaDinh.ghiChu != null && !hoGiaDinh.ghiChu.isEmpty()}">
                            <span class="info-label">Ghi ch√∫:</span>
                            <span class="info-value" th:text="${hoGiaDinh.ghiChu}">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Th√†nh vi√™n h·ªô gia ƒë√¨nh -->
                <div class="detail-card">
                    <h3 style="margin-bottom: 20px; color: #1e293b; font-size: 20px;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Th√†nh vi√™n h·ªô gia ƒë√¨nh</h3>
                    
                    <!-- B·∫£ng danh s√°ch th√†nh vi√™n -->
                    <div style="overflow-x: auto; margin-bottom: 30px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>CCCD</th>
                                    <th>H·ªç v√† t√™n</th>
                                    <th>Ng√†y sinh</th>
                                    <th>Quan h·ªá</th>
                                    <th>Ch·ªß h·ªô</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="memberTableBody">
                                <tr th:each="tv : ${thanhVienList}">
                                    <td th:text="${tv.cccd}"></td>
                                    <td th:text="${tv.doiTuong?.hoVaTen}"></td>
                                    <td th:text="${tv.doiTuong?.ngaySinh != null ? #temporals.format(tv.doiTuong.ngaySinh, 'dd/MM/yyyy') : '-'}"></td>
                                    <td th:text="${tv.quanHeVoiChuHo}"></td>
                                    <td>
                                        <span th:if="${tv.laChuHo}" class="badge badge-success">‚úì</span>
                                        <span th:unless="${tv.laChuHo}">-</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-danger btn-remove-member" 
                                                th:attr="data-cccd=${tv.cccd},data-ngay-bat-dau=${tv.ngayBatDau}">X√≥a</button>
                                    </td>
                                </tr>
                                <tr id="emptyRow" th:if="${thanhVienList == null or thanhVienList.isEmpty()}">
                                    <td colspan="6" style="text-align: center; color: #94a3b8;">Ch∆∞a c√≥ th√†nh vi√™n n√†o</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- T√¨m ki·∫øm v√† th√™m th√†nh vi√™n -->
                    <div style="border-top: 2px solid #e2e8f0; padding-top: 20px;">
                        <div class="member-search-section">
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 15px;">
                                <div style="position: relative;">
                                    <label for="searchCuDan" style="font-weight: 600; margin-bottom: 8px; display: block;">T√¨m ki·∫øm c∆∞ d√¢n:</label>
                                    <input type="text" id="searchCuDan" class="form-control" 
                                           placeholder="Nh·∫≠p t√™n, CCCD ho·∫∑c SƒêT ƒë·ªÉ t√¨m ki·∫øm..." autocomplete="off">
                                    <!-- Dropdown k·∫øt qu·∫£ -->
                                    <div id="searchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; 
                                        background: white; border: 1px solid #cbd5e1; border-radius: 6px; max-height: 300px; 
                                        overflow-y: auto; z-index: 1000; margin-top: 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                                </div>
                                <div>
                                    <label for="quanHe" style="font-weight: 600; margin-bottom: 8px; display: block;">Quan h·ªá v·ªõi ch·ªß h·ªô:</label>
                                    <select id="quanHe" class="form-control">
                                        <option value="Ch·ªß h·ªô">Ch·ªß h·ªô</option>
                                        <option value="V·ª£/Ch·ªìng">V·ª£/Ch·ªìng</option>
                                        <option value="Con">Con</option>
                                        <option value="B·ªë/M·∫π">B·ªë/M·∫π</option>
                                        <option value="Anh/Ch·ªã/Em">Anh/Ch·ªã/Em</option>
                                        <option value="Kh√°c">Kh√°c</option>
                                    </select>
                                </div>
                            </div>

                            <button type="button" id="btnAddMember" class="btn btn-primary" disabled>
                                ‚ûï Th√™m th√†nh vi√™n
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script th:src="@{/js/script.js}"></script>
    <script th:inline="javascript">
        let selectedCuDan = null;
        let searchTimeout = null;
        
        const searchInput = document.getElementById('searchCuDan');
        const searchResults = document.getElementById('searchResults');
        const btnAddMember = document.getElementById('btnAddMember');
        const maHo = /*[[${hoGiaDinh.maHo}]]*/ 'H001';
        
        // T√¨m ki·∫øm c∆∞ d√¢n v·ªõi debounce
        searchInput.addEventListener('input', function() {
            const keyword = this.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (keyword.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                fetch(`/admin/ho-gia-dinh/api/search-cudan?keyword=${encodeURIComponent(keyword)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length > 0) {
                            let html = '';
                            data.forEach(cuDan => {
                                const ngaySinh = cuDan.ngaySinh || '';
                                html += `
                                    <div class="search-item" style="padding: 12px; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: background 0.2s;"
                                         onmouseover="this.style.background='#f1f5f9'" 
                                         onmouseout="this.style.background='white'"
                                         onclick="selectCuDan('${cuDan.cccd}', '${cuDan.hoVaTen}', '${ngaySinh}', '${cuDan.soDienThoai || ''}')">
                                        <div style="font-weight: 600; color: #1e293b;">${cuDan.hoVaTen}</div>
                                        <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                            CCCD: ${cuDan.cccd} | SƒêT: ${cuDan.soDienThoai || 'N/A'}
                                        </div>
                                    </div>
                                `;
                            });
                            searchResults.innerHTML = html;
                            searchResults.style.display = 'block';
                        } else {
                            searchResults.innerHTML = '<div style="padding: 12px; text-align: center; color: #94a3b8;">Kh√¥ng t√¨m th·∫•y c∆∞ d√¢n n√†o</div>';
                            searchResults.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        searchResults.style.display = 'none';
                    });
            }, 300);
        });
        
        // H√†m ch·ªçn c∆∞ d√¢n
        window.selectCuDan = function(cccd, hoVaTen, ngaySinh, soDienThoai) {
            selectedCuDan = { cccd, hoVaTen, ngaySinh, soDienThoai };
            searchInput.value = hoVaTen + ' (' + cccd + ')';
            searchResults.style.display = 'none';
            btnAddMember.disabled = false;
        };
        
        // ƒê√≥ng dropdown khi click b√™n ngo√†i
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });
        
        // Th√™m th√†nh vi√™n
        btnAddMember.addEventListener('click', function() {
            if (!selectedCuDan) {
                showNotification('Vui l√≤ng ch·ªçn c∆∞ d√¢n', 'warning');
                return;
            }
            
            const quanHe = document.getElementById('quanHe').value;
            // N·∫øu kh√¥ng c√≥ checkbox "L√† ch·ªß h·ªô" th√¨ m·∫∑c ƒë·ªãnh theo l·ª±a ch·ªçn quan h·ªá
            const laChuHoEl = document.getElementById('laChuHo');
            const laChuHo = laChuHoEl ? !!laChuHoEl.checked : (quanHe === 'Ch·ªß h·ªô');
            
            const formData = new FormData();
            formData.append('maHo', maHo);
            formData.append('cccd', selectedCuDan.cccd);
            formData.append('quanHe', quanHe);
            formData.append('laChuHo', laChuHo);
            
            // Disable button temporarily
            btnAddMember.disabled = true;
            const originalText = btnAddMember.textContent;
            btnAddMember.textContent = '‚è≥ ƒêang th√™m...';
            
            fetch('/admin/ho-gia-dinh/api/add-member', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('L·ªói khi th√™m th√†nh vi√™n');
                }
                return response.text();
            })
            .then(message => {
                // X√≥a d√≤ng "Ch∆∞a c√≥ th√†nh vi√™n n√†o" n·∫øu c√≥
                const emptyRow = document.getElementById('emptyRow');
                if (emptyRow) {
                    emptyRow.remove();
                }
                
                // Th√™m d√≤ng m·ªõi v√†o b·∫£ng
                const tbody = document.getElementById('memberTableBody');
                const newRow = document.createElement('tr');
                
                // Format ng√†y sinh n·∫øu c√≥
                let ngaySinhFormatted = '-';
                if (selectedCuDan.ngaySinh) {
                    try {
                        const date = new Date(selectedCuDan.ngaySinh);
                        ngaySinhFormatted = date.toLocaleDateString('vi-VN');
                    } catch (e) {
                        ngaySinhFormatted = '-';
                    }
                }
                
                newRow.innerHTML = `
                    <td>${selectedCuDan.cccd}</td>
                    <td>${selectedCuDan.hoVaTen}</td>
                    <td>${ngaySinhFormatted}</td>
                    <td>${quanHe}</td>
                    <td>${laChuHo ? '<span class="badge badge-success">‚úì</span>' : '-'}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger btn-remove-member" 
                                data-cccd="${selectedCuDan.cccd}" data-ngay-bat-dau="${new Date().toISOString().split('T')[0]}">X√≥a</button>
                    </td>
                `;
                
                // Highlight new row
                newRow.style.backgroundColor = '#d1fae5';
                tbody.appendChild(newRow);
                
                setTimeout(() => {
                    newRow.style.backgroundColor = '';
                }, 2000);
                
                // Attach event listener cho n√∫t x√≥a m·ªõi
                attachRemoveEventToButton(newRow.querySelector('.btn-remove-member'));
                
                // Show success notification
                showNotification('‚úì ƒê√£ th√™m th√†nh vi√™n th√†nh c√¥ng', 'success');
                
                // Reset form
                searchInput.value = '';
                document.getElementById('quanHe').value = 'Ch·ªß h·ªô';
                const laChuHoReset = document.getElementById('laChuHo');
                if (laChuHoReset) laChuHoReset.checked = false;
                selectedCuDan = null;
                
                // Re-enable button
                btnAddMember.textContent = originalText;
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('‚úó C√≥ l·ªói x·∫£y ra khi th√™m th√†nh vi√™n', 'error');
                btnAddMember.disabled = false;
                btnAddMember.textContent = originalText;
            });
        });
        
        // Function ƒë·ªÉ attach event listener cho n√∫t x√≥a
        function attachRemoveEventToButton(btn) {
            btn.addEventListener('click', function() {
                const cccd = this.getAttribute('data-cccd');
                const ngayBatDau = this.getAttribute('data-ngay-bat-dau');
                const row = this.closest('tr');
                const formData = new FormData();
                formData.append('maHo', maHo);
                formData.append('cccd', cccd);
                formData.append('ngayBatDau', ngayBatDau);
                
                // Visual feedback
                row.style.opacity = '0.5';
                
                fetch('/admin/ho-gia-dinh/api/remove-member', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('L·ªói khi x√≥a th√†nh vi√™n');
                    }
                    return response.text();
                })
                .then(message => {
                    // X√≥a d√≤ng kh·ªèi b·∫£ng v·ªõi animation
                    row.style.transition = 'all 0.3s ease';
                    row.style.backgroundColor = '#fee2e2';
                    
                    setTimeout(() => {
                        row.remove();
                        
                        // Ki·ªÉm tra n·∫øu b·∫£ng tr·ªëng th√¨ hi·ªÉn th·ªã l·∫°i d√≤ng "Ch∆∞a c√≥ th√†nh vi√™n n√†o"
                        const tbody = document.getElementById('memberTableBody');
                        if (tbody.children.length === 0) {
                            const emptyRow = document.createElement('tr');
                            emptyRow.id = 'emptyRow';
                            emptyRow.innerHTML = '<td colspan="6" style="text-align: center; color: #94a3b8;">Ch∆∞a c√≥ th√†nh vi√™n n√†o</td>';
                            tbody.appendChild(emptyRow);
                        }
                        
                        showNotification('‚úì ƒê√£ x√≥a th√†nh vi√™n', 'success');
                    }, 300);
                })
                .catch(error => {
                    console.error('Error:', error);
                    row.style.opacity = '1';
                    showNotification('‚úó C√≥ l·ªói x·∫£y ra khi x√≥a th√†nh vi√™n', 'error');
                });
            });
        }
        
        // Function ƒë·ªÉ hi·ªÉn th·ªã notification
        function showNotification(message, type) {
            // Remove existing notification if any
            const existing = document.querySelector('.custom-notification');
            if (existing) {
                existing.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = 'custom-notification';
            notification.textContent = message;
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b'
            };
            
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${colors[type] || colors.success};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                animation: slideIn 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Attach event listener cho t·∫•t c·∫£ n√∫t x√≥a hi·ªán c√≥
        document.querySelectorAll('.btn-remove-member').forEach(btn => {
            attachRemoveEventToButton(btn);
        });
    </script>
</body>
</html>

